---
  title: "Methods and Results"
  author: 
  date: "`r Sys.Date()`"
  bibliography: refs.bib
  csl: pnas.csl
  output: 
    bookdown::word_document2:
      toc: no
      toc_depth: 6
      number_sections: false
      reference_docx: template.docx
    bookdown::html_document2:
      code_folding: hide
      number_sections: no
      toc: yes
      toc_depth: 6
      toc_float: yes
  editor_options: 
    chunk_output_type: console
---
```{r setup, include=FALSE}
  knitr::opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE, warning = FALSE, tidy = TRUE, fig.width = 10)
  ## numbers >= 10^5 will be denoted in scientific notation,      ## numbers >= 10^5 will be denoted in scientific notation,
    ## and rounded to 2 digits      ## and rounded to 2 digits
    options(digits = 2)
```

```{r loadpackages, echo = FALSE, results = "hide"}
  pacman::p_load(tidyverse, metafor, brms, metaAidR, ape, phytools, metaAidR, orchaRd, gt, kableExtra, flextable)
  source("./R/func.R")
```
```{r loaddata, echo = FALSE, results = "hide"}
  # Tree
      data <- read.csv("./data/meta_data.csv")
      data <- data %>% 
              mutate(species2 = species)
  
  # Bring in and prune tree
       tree <- read.tree("./phylogeny/tree")
       tree$tip.label <- gsub("_", " ", tree$tip.label)
  phylogeny <- vcv(tree, corr=TRUE)

  # Summary statistics for the results
  inverts <- data %>% 
             mutate(insect = ifelse(class %in% c("Insecta", "Gastropoda", "Malacostraca", "Arachnida", "Clitellata (Phylum Annelida)",  "Secernentea (Phylum Nematoda)"), 1,0))

  parity <- data %>% group_by(species) %>% summarise(parity = unique(Gestation)) %>% group_by(parity) %>% summarise(n=n())

###################
# Multilevel Meta-analytic Models (intercept only), plus robust variace estimation test.
###################
  
  model1.1 <- rma.mv(SMDH ~ 1, V = data$v_SMDH, random = list(~1|study, ~1|variable, ~1|species, ~1|obs), test = "t", data = data)
    robust <- robust(model1.1, cluster = data$study)
  
  model1.2 <- rma.mv(SMDH ~ 1, V = data$v_SMDH, random = list(~1|study, ~1|variable, ~1|species, ~1|species2, ~1|obs), R = list(species2 = phylogeny), test = "t", data = data)
  
  AIC(model1.2, model1.1) # Phylogeny explains very little variation; model without phylogeny better supported, even if slightly. Just keep species in model

# Table 1: Effect, confidemce intervals, prediction intervals, heterogenity
            table1 <- make_table(model1.1, data)
      hetero_table <- I2(model1.1, v = data$v_SMDH)
hetero_table_phylo <- I2(model1.2, v = data$v_SMDH, phylo = "species2")

###################
# Publication bias. Based on funnel plot, it looks like pub bias. Correct effect as a sensitivity analysis
###################
  
     data$inv_n_eff <- with(data, (N_C + N_T) / (N_C * N_T))
  
       model1.1_pub <- rma.mv(SMDH ~ sqrt(inv_n_eff), V = data$v_SMDH, random = list(~1|study, ~1|variable, ~1|species, ~1|obs), test = "t", data = data)
  
  model1.1_pub_full <- rma.mv(SMDH ~ sqrt(inv_n_eff) + SSD_lnRR + Harm_type, V = data$v_SMDH, random = list(~1|study, ~1|variable, ~1|species, ~1|obs), test = "t", data = data)

###################
# Meta-regressions
###################
  
  model1.3 <- rma.mv(SMDH ~ SSD_lnRR, V = data$v_SMDH, random = list(~1|study, ~1|variable, ~1|species, ~1|obs), test = "t", data = data)
  robust(model1.3, cluster = data$study)

  model1.4 <- rma.mv(SMDH ~ Harm_type-1, V = data$v_SMDH, random = list(~1|study, ~1|species, ~1|obs), R = list(species = phylogeny), test = "t", data = data)
  robust(model1.4, cluster = data$study)

  model1.5 <- rma.mv(SMDH ~ Harm_type + SSD_lnRR, V = data$v_SMDH, random = list(~1|study, ~1|obs, ~1|species), R = list(species = phylogeny), test = "t", data = data)
  robust(model1.5, cluster = data$study)



```
# Methods


# Results

Overall, we collected effect sizes for a total of `r length(unique(data$species))` species from `r length(unique(data$study))` studies. Unsurprisingly, invertebrates (classes: Insecta, Gastropoda, Malacostraca, Arachnida, Clitellata and Secernentea) made up most of the data (`r (table(inverts$insect)[2] / sum(table(inverts$insect)))*100`%). We obtained `r table(data$Harm_type)[2]` effect sizes from manipulations on species that resulted in direct harm (e.g., traumatic insemination), whereas `r table(data$Harm_type)[3]` effects came from studies on species that manipulated indirect harm to females (e.g., mating rate and harassment). A total of `r table(data$Harm_type)[1]` effect sizes were from experiment where females received both direct and indirect harm from male matings. 

Across all species, we obtained `r table(data$Gestation)[1]` effects from `r parity[1,2]` oviparous species, and `r table(data$Gestation)[2]` effects from `r parity[2,2]` viviparous species. Unfortunately, effect sizes from viviparous species were all take from studies on fish species with indirect male harm. As such, we analyzed only 'harm type' and an index of sexual size dimorphism.

#### Manipulating direct and indirect female harm negatively impacts female fitness

Experimentally manipulating female harm resulted in a strong decrease in female fitness overall (i.e., positive effect size with control group females having higher fitness than treatment groups: `r model1.1$beta`, 95% CI: `r model1.1$ci.lb` to `r model1.1$ci.ub`, $n_{effects}$ = `r model1.1$k.all`, $n_{study}$ = `r model1.1$s.nlevels[1]`). This strong effect held even when accounting for within-study non-independence (Meta-analytic mean using Robust Variance Estimator: `r robust$beta`, 95% CI: `r robust$ci.lb` to `r robust$ci.ub`). However, visual inspection of funnel plot asymmetry suggested evidence for publication bias (i.e., missed effects sizes with low precision when female harm was worse in control treatments) (Figure \@ref(fig:funnel)). Evidence for publication bias was confirmed through the identification of a significant slope between effect size and effective sample size ($\beta$ = `r model1.1_pub$beta[2]`, 95% CI: `r model1.1_pub$ci.lb[2]` to `r model1.1_pub$ci.ub[2]`), and this held true when accounting for heterogenity using meta-regression models ($\beta$ =`r model1.1_pub_full$beta[2]`, 95% CI: `r model1.1_pub_full$ci.lb[2]` to `r model1.1_pub_full$ci.ub[2]`). Correcting for the possibility of missing studies resulted in the overall meta-analytic mean effect size being indistinguisable from zero (Corrected meta-analytic mean: `r model1.1_pub$beta[1]`, 95% CI: `r model1.1_pub$ci.lb[1]` to `r model1.1_pub$ci.ub[1]`). It is important recognise that the corrected meta-analytic mean is simply a sensitivity analysis, and we cannot know for certain whether there indeed are and how many, missing studies.

When accouting for sampling variance there was high effect size heterogeneity ($I^2_{Total}$ = `r hetero_table$I2_Est.[nrow(hetero_table)]`, 95% CI: `r hetero_table[nrow(hetero_table), "2.5% CI"]` to `r hetero_table[nrow(hetero_table), "97.5% CI"]`) with most variance being the result of between study ($I^2_{Study}$ = `r hetero_table$I2_Est.[1]`, 95% CI: `r hetero_table[1, "2.5% CI"]` to `r hetero_table[1, "97.5% CI"]`) and between species ($I^2_{Species}$ = `r hetero_table$I2_Est.[3]`, 95% CI: `r hetero_table[3, "2.5% CI"]` to `r hetero_table[3, "97.5% CI"]`) effects. The trait type and phylogeny explained much less variation overall ($I^2_{Trait}$ = `r hetero_table$I2_Est.[2]`, 95% CI: `r hetero_table[2, "2.5% CI"]` to `r hetero_table[2, "97.5% CI"]`; $I^2_{Phylogeny}$ = `r hetero_table_phylo$I2_Est.[5]`, 95% CI: `r hetero_table_phylo[5, "2.5% CI"]` to `r hetero_table_phylo[5, "97.5% CI"]`). 

```{r funnel, fig.height=4.5, fig.width=4.5, fig.cap="Funnel plot of effect size as a function of precision (i.e., inverse of sampling standard error). 95% pseudoconfidence intervals are provuded."}
funnel(model1.1, yaxis="seinv", digits = 2, las = 1)

```
```{r pretty_table}

autonum <- officer::run_autonum(seq_id = "tab", pre_label = "Table 1", bkm_all = TRUE)
ft <- flextable(table1)
ft <- set_caption(ft,  caption = "Effect size", autonum = autonum)
ft <- set_header_labels(ft, n = md("$n_{effects}$"),
                    std = md("**n<sub>studies<sub>**"),
                     spp = md("**n<sub>species<sub>**"),
                  est = md("**Meta-analytic mean**"),
                    CI = md("**95% CI**"),
                    PI = md("**95% PI**"),
              i2_stdy = md("***I*<sup>2</sup><sub>study</sub>\n(%)**"),
            i2_trait = md("***I*<sup>2</sup><sub>trait</sub>\n(%)**"),
           i2_species = md("***I*<sup>2</sup><sub>species</sub>\n(%)**"),
             i2_tot = md("***I*<sup>2</sup><sub>total</sub>    \n(%)**"))
ft

```

#### Negative effects on fitness depend on the type of harm done to females



#### Female fitness is comproised more in species with male-biased sexual size dimorphism (SSD) 